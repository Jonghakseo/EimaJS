#!/usr/bin/env node
"use strict";var __assign=function(){return __assign=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++)for(var e in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a},__assign.apply(this,arguments)},__awaiter=function(a,b,c,d){function e(a){return a instanceof c?a:new c(function(b){b(a)})}return new(c||(c=Promise))(function(c,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?c(a.value):e(a.value).then(g,h)}i((d=d.apply(a,b||[])).next())})},__generator=function(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;k;)try{if(e=1,h&&(i=2&c[0]?h["return"]:c[0]?h["throw"]||((i=h["return"])&&i.call(h),0):h.next)&&!(i=i.call(h,c[1])).done)return i;switch((h=0,i)&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return k.label++,{value:c[1],done:!1};case 5:k.label++,h=c[1],c=[0];continue;case 7:c=k.ops.pop(),k.trys.pop();continue;default:if((i=k.trys,!(i=0<i.length&&i[i.length-1]))&&(6===c[0]||2===c[0])){k=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){k.label=c[1];break}if(6===c[0]&&k.label<i[1]){k.label=i[1],i=c;break}if(i&&k.label<i[2]){k.label=i[2],k.ops.push(c);break}i[2]&&k.ops.pop(),k.trys.pop();continue;}c=b.call(a,k)}catch(a){c=[6,a],h=0}finally{e=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,h,i,j,k={label:0,sent:function sent(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return j={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(j[Symbol.iterator]=function(){return this}),j};Object.defineProperty(exports,"__esModule",{value:!0}),exports.eimaStart=void 0;var fs=require("fs"),path=require("path"),util_1=require("./util"),constants_1=require("./constants"),util_js_1=require("./util.js");function eimaStart(){var a=(0,util_1.getConfig)(),b=a||constants_1.DEFAULT_CONFIG;a?(0,util_js_1.help)("eima.json Has been found."):(0,util_js_1.help)("Could not be found or read eima.json. Operate in simple mode."),b.target===constants_1.ES_VERSION.ES5||b.target===constants_1.ES_VERSION.ES6||((0,util_js_1.err)("Please check the target ecma script version in eima.json. (es5/es6)"),process.exit()),b.paths.forEach(function(a){void assetsToImportFile(a,b)})}exports.eimaStart=eimaStart;function makeAssetFileText(a){var b=a.config.target,c="// ".concat(constants_1.EIMA_ASSET_EXPORT_FILE,"\n"),d="";return b===constants_1.ES_VERSION.ES5&&(d=makeAssetFileTextEs5(a)),b===constants_1.ES_VERSION.ES6&&(d=makeAssetFileTextEs6(a)),c+d}function makeAssetFileTextEs6(a){var b=a.config,c=a.assetFileInfo,d=a.depthPrefix,e=a.basePath,f=a.variableName,g=b.hideSize,h=c.map(function(a){var b=a.constName,c=a.filePath,f=a.size,h=g?"":"// ".concat(f);return"import ".concat(b," from \"").concat(d).concat(e,"/").concat(c,"\"; ").concat(h)}).join("\n"),i="const ".concat(f," = {\n  ").concat(c.map(function(a){var b=a.constName;return b}).join(",\n  "),"\n};");return h+"\n\n"+i+"\n\nexport default ".concat(f,";")}function makeAssetFileTextEs5(a){var b=a.config,c=a.assetFileInfo,d=a.depthPrefix,e=a.basePath,f=a.variableName,g=b.hideSize,h=c.map(function(a){var b=a.constName,c=a.filePath,f=a.size,h=g?"":"// ".concat(f);return"var ".concat(b," = require(\"").concat(d).concat(e,"/").concat(c,"\"); ").concat(h)}).join("\n"),i="var ".concat(f," = {\n  ").concat(c.map(function(a){var b=a.constName;return b}).join(",\n  "),"\n};");return h+"\n\n"+i+"\n\nmodule.exports = ".concat(f,";")}function updateAssetsFile(a){return __awaiter(this,void 0,void 0,function(){var b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t;return __generator(this,function(i){switch(i.label){case 0:return b=a.assets,c=a.out,d=a.vName,e=a.variableNameCasing,f=a.target,g=a.isIncludingExt,h=(0,util_1.getCasingType)(e),j=path.resolve(process.cwd(),b),[4,(0,util_1.getFileList)(j,[])];case 1:for(k=i.sent(),l=k.flat(1/0).filter(Boolean).map(function(a){var b=a.name,c=a.ext,d=a.filePath,e=a.size,f=h(b,c,d,e,g);return{constName:f,filePath:d,size:e}}),m=/\//g,n=Array.from(c.matchAll(m)).length,o="",p=0;p<n;p++)o+="../";return q={config:a,assetFileInfo:l,depthPrefix:o,basePath:b,variableName:d},r=makeAssetFileText(q),(0,util_js_1.log)(c),s=path.resolve(process.cwd(),"".concat(c)),fs.writeFileSync(s,r),t=f===constants_1.ES_VERSION.ES5?3:2015,[4,(0,util_1.fixEslint)(c,t)];case 2:return i.sent(),[2];}})})}function assetsToImportFile(a,b){return __awaiter(this,void 0,void 0,function(){var c,d,e,f;return __generator(this,function(g){switch(g.label){case 0:if(c=a.assets,d=a.out,e=a.vName,!c)return[2,(0,util_js_1.err)("PLEASE CHECK THE ASSET PATH. assets: ".concat(c))];if(!d)return[2,(0,util_js_1.err)("PLEASE CHECK THE OUTFILE. out: ".concat(d))];if(!e)return[2,(0,util_js_1.err)("PLEASE CHECK THE VARIABLE NAME. vName: ".concat(e))];g.label=1;case 1:return g.trys.push([1,3,,4]),[4,updateAssetsFile(__assign(__assign({},a),b))];case 2:return g.sent(),fs.watch(c,{recursive:!0},function(c,d){(0,util_js_1.log)("DETECT FILE CHANGES [".concat(c," EVENT] - ").concat(d||"_UNKNOWN_")),updateAssetsFile(__assign(__assign({},a),b))}),[3,4];case 3:return f=g.sent(),(0,util_js_1.err)("THERE WAS A PROBLEM UPDATING THE FILE."),console.error(f),[3,4];case 4:return[2];}})})}
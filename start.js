"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.eimaStart=eimaStart;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_util=require("./util"),_constants=require("./constants"),_ink=require("./ink");function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function eimaStart(){var a=(0,_util.getConfig)(),b=a||_constants.DEFAULT_CONFIG;a?(0,_ink.help)("eima.json Has been found."):(0,_ink.help)("Could not be found or read eima.json. Operate in simple mode."),b.target===_constants.ES_VERSION.ES5||b.target===_constants.ES_VERSION.ES6||((0,_ink.err)("Please check the target ecma script version in eima.json. (es5/es6)"),process.exit()),b.paths.forEach(function(a){void assetsToImportFile(a,b)})}function makeAssetFileText(a){var b=a.config.target,c="// ".concat(_constants.EIMA_ASSET_EXPORT_FILE,"\n"),d="";return b===_constants.ES_VERSION.ES5&&(d=makeAssetFileTextEs5(a)),b===_constants.ES_VERSION.ES6&&(d=makeAssetFileTextEs6(a)),c+d}function makeAssetFileTextEs6(a){var b=a.config,c=a.assetFileInfo,d=a.depthPrefix,e=a.basePath,f=a.variableName,g=b.hideSize,h=c.map(function(a){var b=a.constName,c=a.filePath,f=a.size,h=g?"":"// ".concat(f);return"import ".concat(b," from \"").concat(d).concat(e,"/").concat(c,"\"; ").concat(h)}).join("\n"),i="const ".concat(f," = {\n  ").concat(c.map(function(a){var b=a.constName;return b}).join(",\n  "),"\n};");return h+"\n\n"+i+"\n\nexport default ".concat(f,";")}function makeAssetFileTextEs5(a){var b=a.config,c=a.assetFileInfo,d=a.depthPrefix,e=a.basePath,f=a.variableName,g=b.hideSize,h=c.map(function(a){var b=a.constName,c=a.filePath,f=a.size,h=g?"":"// ".concat(f);return"var ".concat(b," = require(\"").concat(d).concat(e,"/").concat(c,"\"); ").concat(h)}).join("\n"),i="var ".concat(f," = {\n  ").concat(c.map(function(a){var b=a.constName;return b}).join(",\n  "),"\n};");return h+"\n\n"+i+"\n\nmodule.exports = ".concat(f,";")}function updateAssetsFile(){return _updateAssetsFile.apply(this,arguments)}function _updateAssetsFile(){return _updateAssetsFile=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=a.assets,d=a.out,e=a.vName,f=a.target,g=a.isIncludingExt,h=_path["default"].resolve(process.cwd(),c),(0,_ink.log)("GETTING LIST OF FILES..."),b.next=5,(0,_util.getFileList)(h,[]);case 5:for(j=b.sent,k=j.flat(1/0).filter(Boolean).map(function(a){var b=a.name,c=a.ext,d=a.filePath,e=a.size,f="".concat(b.replace(/[^ㄱ-ㅎ|가-힣\w\s]/gim,"_")).concat(g?"_".concat(c.toUpperCase()):"");return{constName:f,filePath:d,size:e}}),l=/\//g,m=Array.from(d.matchAll(l)).length,n="",o=0;o<m;o++)n+="../";return p={config:a,assetFileInfo:k,depthPrefix:n,basePath:c,variableName:e},q=makeAssetFileText(p),(0,_ink.log)("CREATING ASSET IMPORT FILE..."),(0,_ink.log)(d),r=_path["default"].resolve(process.cwd(),"".concat(d)),_fs["default"].writeFileSync(r,q),(0,_ink.log)("RUNNING ESLINT..."),s=f===_constants.ES_VERSION.ES5?3:2015,b.next=21,(0,_util.fixEslint)(d,s);case 21:(0,_ink.log)("".concat(c," - ASSETFILE HAS BEEN SUCCESSFULLY UPDATED."));case 22:case"end":return b.stop();}},b)})),_updateAssetsFile.apply(this,arguments)}function assetsToImportFile(){return _assetsToImportFile.apply(this,arguments)}function _assetsToImportFile(){return _assetsToImportFile=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(a,b){var d,e,f;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(d=a.assets,e=a.out,f=a.vName,d){c.next=3;break}return c.abrupt("return",(0,_ink.err)("PLEASE CHECK THE ASSET PATH. assets: ".concat(d)));case 3:if(e){c.next=5;break}return c.abrupt("return",(0,_ink.err)("PLEASE CHECK THE OUTFILE. out: ".concat(e)));case 5:if(f){c.next=7;break}return c.abrupt("return",(0,_ink.err)("PLEASE CHECK THE VARIABLE NAME. vName: ".concat(f)));case 7:return c.prev=7,c.next=10,updateAssetsFile(_objectSpread(_objectSpread({},a),b));case 10:_fs["default"].watch(d,{recursive:!0},function(c,d){(0,_ink.log)("DETECT FILE CHANGES [".concat(c," EVENT] - ").concat(d||"_UNKNOWN_")),updateAssetsFile(_objectSpread(_objectSpread({},a),b))}),c.next=17;break;case 13:c.prev=13,c.t0=c["catch"](7),(0,_ink.err)("THERE WAS A PROBLEM UPDATING THE FILE."),console.error(c.t0);case 17:case"end":return c.stop();}},c,null,[[7,13]])})),_assetsToImportFile.apply(this,arguments)}
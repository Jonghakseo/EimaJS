"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.createConfigFile=createConfigFile,exports.fixEslint=fixEslint,exports.getConfig=getConfig,exports.getFileList=getFileList,exports.getFilePathList=getFilePathList,exports.getLineInput=getLineInput,exports.mergeAllSourceFile=mergeAllSourceFile;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_util=_interopRequireDefault(require("util")),_readline=_interopRequireDefault(require("readline")),_constants=require("./constants"),_ink=require("./ink"),_eslint=require("eslint");function getLineInput(a){var b=_readline["default"].createInterface({input:process.stdin,output:process.stdout,terminal:!1});b.on("line",function(c){b.close(),a(c)})}var readdir=_util["default"].promisify(_fs["default"].readdir);function getFileList(){return _getFileList.apply(this,arguments)}function _getFileList(){return _getFileList=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(a,b){var d,e;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return d=b?"".concat(a,"/").concat(b.join("/")):a,c.next=3,readdir(d);case 3:return e=c.sent,c.abrupt("return",Promise.all(e.map(function(c){var e=Math.round;var f=_path["default"].resolve(d,c),g=_fs["default"].statSync(f);if(0<c.length&&"."===c.charAt(0))return null;if(g.isDirectory())return getFileList(a,[].concat((0,_toConsumableArray2["default"])(b),[c]));if(g.isFile()){var h=c.toUpperCase().split(".")[0];if(h.substr(0,1).match(/^[0-9]/))throw new Error("[".concat(_constants.EIMA,"] A NUMBER CANNOT BE AT THE BEGINNING OF THE FILE NAME."));var i=_path["default"].extname(c).slice(1),j="kb",k=g.size,l=e(k/1024);1024<l&&(l=e(l/102.4)/10,j="mb");var m=c;return 0<b.length&&(h="".concat(b.join("_").toUpperCase(),"_").concat(h),m="".concat(b.join("/"),"/").concat(c)),new Promise(function(a){a({name:h,ext:i,filePath:m,size:"".concat(l).concat(j),_fullFilePath:f,_rawSize:k})})}return null})));case 5:case"end":return c.stop();}},c)})),_getFileList.apply(this,arguments)}function getFilePathList(){return _getFilePathList.apply(this,arguments)}function _getFilePathList(){return _getFilePathList=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(a,b){var d,e;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return d=b?"".concat(a,"/").concat(b.join("/")):a,c.next=3,readdir(d);case 3:return e=c.sent,c.abrupt("return",Promise.all(e.map(function(c){var e=_path["default"].resolve(d,c),f=_fs["default"].statSync(e);if(f.isDirectory())return getFilePathList(a,[].concat((0,_toConsumableArray2["default"])(b),[c]));if(f.isFile()){var g=c;return 0<b.length&&(g="".concat(b.join("/"),"/").concat(c)),new Promise(function(a){a(g)})}return null})));case 5:case"end":return c.stop();}},c)})),_getFilePathList.apply(this,arguments)}function createConfigFile(){return _createConfigFile.apply(this,arguments)}function _createConfigFile(){return _createConfigFile=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function e(a,b,c,d){var f,g;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:f={target:a,hideSize:!1,lintPath:"src",paths:[{assets:b,out:c,vName:d}]},g=_path["default"].resolve(process.cwd(),"eima.json"),_fs["default"].writeFileSync(g,JSON.stringify(f));case 3:case"end":return e.stop();}},e)})),_createConfigFile.apply(this,arguments)}function fixEslint(){return _fixEslint.apply(this,arguments)}function _fixEslint(){return _fixEslint=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f=arguments;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=1<f.length&&void 0!==f[1]?f[1]:2015,d=new _eslint.ESLint({fix:!0,overrideConfig:{parserOptions:{ecmaVersion:c}}}),b.next=4,d.lintFiles([a]);case 4:return e=b.sent,b.next=7,_eslint.ESLint.outputFixes(e);case 7:case"end":return b.stop();}},b)})),_fixEslint.apply(this,arguments)}function mergeAllSourceFile(a,b,c){var d="",e=0;b.forEach(function(f){_fs["default"].readFile("".concat(a).concat(f),"utf-8",function(a,f){if(a)throw a;else-1===f.indexOf(_constants.EIMA_ASSET_EXPORT_FILE)&&(d+=f),e+=1,e===b.length&&c(d)})})}function getConfig(){var a=_path["default"].resolve(process.cwd(),"eima.json"),b=null;try{var c=JSON.parse(_fs["default"].readFileSync(a,"utf8"));c.paths&&0!==c.paths.length?b=c:(0,_ink.help)("Please check paths property in eima.json")}catch(a){a.path&&a.path.includes("eima.json")||console.error(a)}return b}